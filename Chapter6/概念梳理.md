# 存储器层次优化

> 专注于梳理本章中出现的重要概念，对概念的描述尽量做到述而不作，避免因为个人理解偏差对其他人造成误导。
>
> 本章主要介绍为CPU存放指令和数据的存储器系统，以及其对应的层次结构，一定程度上能帮助我们理解，如何通过数据访问局部性，来提高程序性能。

* 存储器系统（memory system）

  具有不同容量，成本和访问时间的存储设备的层级结构。CPU寄存器保存最常用的数据，靠近CPU的小的、快速的高速缓存存储器（cache memory）作为一部分存储在相对慢速的主存储器（main memory）中数据和指令的缓冲区域。主存缓存存储在容量较大的、慢速磁盘上的数据，而这些磁盘又作为存储在通过网络连接的其他机器的磁盘或磁带上的数据的缓冲区域。

* 访问局部性（locality）

  具有良好局部性的程序倾向于一次又一次地访问相同的数据项集合，或是倾向于访问邻近的数据项集合。具有良好局部性的程序比局部性差的程序更多地倾向于从存储器层次结构中较高层次处访问数据项，因此运行的更快。

## 存储技术

* 随机访问存储器

  分为静态RAM和动态RAM，SRAM比DRAM更快，一般作为高速缓存存储器，DRAM一般用于做主存或帧缓冲区，在一个系统中，DRAM能存储的字节数比SRAM多。

  * 静态RAM

    每个位存储在一个双稳态的存储器单元中，每个单元是用一个六晶体管电路来实现的，该电路可以无限期地保持在两个不同的电压配置或状态之一，其他的任何状态都是不稳定的。

    正是由于它的双稳态特性，只要有电，它就会永远的保持它的值，即使有干扰存在。但是每个单元需要六个晶体管，相对代价比较高。

  * 动态RAM

    每个位存储为对一个电容的充电，每个单元由一个非常小的电容和一个访问晶体管组成。但其对干扰非常敏感，而且很多原因会导致漏电，使得DRAM单元在10~100毫秒的时间内失去电荷，所以内存周期必须周期性地通过读出，然后重写来刷新内存每一位。有些系统使用纠错码，计算机的字会被多编码几个位，使得电路可以发现并纠正一个字中任何单个的错误位。

* 传统的DRAM

  DRAM芯片被分成d个超单元，每个超单元都由$w$个DRAM单元组成，一个$d\times w$的DRAM总共存储$dw$位信息。超单元被组织成一个r行c列的长方形阵列。即$rc=d$。用行列的下标来标记每个超单元。如下图所示，是一个128位$16\times 8$的DRAM芯片的组织。信息通过引脚的外部连接器流入和流出芯片，每个引脚携带一个1位的信号，图中所示的8个data引脚，能传送一个字节到芯片或从芯片传出一个字节，以及2个addr引脚，携带2位的行和列超单元地址。

  <img src="images/DRAM芯片的高级视图.png" alt="DRAM芯片的高级视图" style="zoom:67%;" />

  每个DRAM芯片被连接到某个称为内存控制器（memory controller）的电路，内存控制器将行地址发送给DRAM，DRAM将一整行的内容都复制到一个内部缓冲区，内存控制器进而发送列地址，DRAM从行缓冲区读或写对应超单元的$w$位。

  DRAM被组织成二维阵列，可以降低芯片上的地址引脚数量，但必须分两步发送地址，这增加了访问时间。

* 内存模块（memory module）

  DRAM芯片封装在内存模块中，如图所示是用8个64Mbit（$8M\times 8$）的DRAM芯片，总共存储$64MB$，每一个超单元存储主存的一个字节，相应超单元地址的8个超单元表示主存中字节地址A处的64位字。

  <img src="images/内存模块.png" alt="内存模块" style="zoom:67%;" />

  通过将多个内存模块连接到内存控制器，能够聚合成主存。在这种情况下，当控制器收到一个地址A时，控制器选择包含A的模块k，将A转换为$(i, j)$格式，并将$(i,j)$发送到模块k。

* 增强的DRAM

  基于传统的DRAM单元，进行一些优化，提高访问基本DRAM单元的速度。

  * 快页模式DRAM（FPM DRAM）

    允许对同一行连续地访问可以直接从行缓冲区得到服务。

  * 扩展数据输出DRAM（EDO DRAM）

    FPM DRAM的增强形式，允许各个CAS信号在时间上靠得更紧密一点。

  * 同步DRAM（SDRAM）

  * 双倍数据速录同步DRAM（DDR SDRAM）

  * 视频RAM（VRAM）

* 非易失性存储器

  DRAM和SRAM在断电后会丢失它们的信息，相对的有非易失性存储器，ROM以它们能够被重编程（写）的次数和对它们进行重编程所用的机制来区分的。

  * 可编程ROM（Programmable Rom, PROM）

    只能被编程一次，PROM的每个存储单元有一种熔丝，只能用高电流熔断一次。

  * 可擦写可编程ROM（Erasable Programmable ROM, EPROM）

    透明石英窗口，允许光到达存储单元，紫外线光照射过窗口，EPROM单元就被清除为0，对EPROM编程是通过使用一种把1写入EPROM的特殊设备来完成的。其能够被擦除和重编程的次数的数量级可以达到1000次。

  * 电子可擦除PROM（EEPROM）

    不需要一个物理上独立的编程设备，因此可以直接在印刷电路卡上编程。其能够被擦除和重编程的次数第数量级可以达到$10^5$次。

  * 闪存（flash memory）

    基于EEPROM，如固态硬盘（SSD）。

  当一个计算机系统通电以后，它会运行存储在ROM中固件（程序），固件提供了少量基本的输入输出函数。

* 访问主存

  数据流通过总线（bus）的共享电子电路在处理器和DRAM主存之间进行传输。将CPU和主存之间的数据传输步骤称为事务，分为读事务和写事务。

  总线是一组并行的导线，能携带地址、数据和控制信号。具体怎么传输，取决于总线的设计。控制线上携带的信号会同步事务，并标识出当前正在被执行的事务的类型。

  如下图所示的计算机系统，由CPU芯片、I/O桥接器的芯片组、组成主存的DRAM内存模块。这些部件由一对总线连接起来，系统总线（连接CPU和I/O桥接器）和内存总线（连接I/O桥接器和主存），I/O桥接器将系统总线的电子信号翻译成内存总线的电子信号。

  <img src="images/连接CPU和主存的总线结构.png" alt="连接CPU和主存的总线结构" style="zoom:67%;" />

  如下图所示，是指令`movq A, %rax`（将地址A的内容加载到寄存器中）的执行过程。

  CPU芯片上的总线接口电路，发起读事务，首先，CPU将地址A放到系统总线上，I/O桥将信号传递到内存总线，然后主存根据内存总线上的地址信号，从DRAM中取出数据字，并将数据写到内存总线。I/O桥将内存总线信号翻译成系统总线信号，然后沿着系统总线传递，最后CPU感觉到系统总线上的数据，从总线上读数据，并将数据复制到指定寄存器。

  <img src="images/加载操作的内存读事务.png" alt="加载操作的内存读事务" style="zoom:67%;" />

  

